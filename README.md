# Viper Simulation Runner and Batch Processor

This repository contains tools for automating fluid dynamics simulations using Viper, including running multiple simulations with varying parameters, generating Tecplot visualizations, and performing data analysis.

## Workflow

The typical workflow involves the following steps:

1. **Configuration (parameters.csv):** Define simulation parameters in `parameters.csv`. Each row in the CSV file represents a separate simulation run.  The file includes detailed descriptions of each parameter within the first two rows. Key parameters include:
    * **Reynolds number:**  Governs the flow regime (higher values indicate more turbulent flow).
    * **mesh_file:**  Specifies the mesh file to use (e.g., 1, 2, 3, corresponding to increasing mesh resolution).
    * **Polynomial order:**  Influences the accuracy of the solution. Higher orders generally lead to higher accuracy but increased computational cost.
    * **Control amplitude (A):** Magnitude of the control input.
    * **Control frequency (f):** Frequency of the control input signal.
    * **Control up-down balance (b):**  Distributes the control flow between the upper and lower output channels (0 = all upper, 1 = all lower, 0.5 = equal distribution).
    * **Time step (dt):** Time increment for the simulation. Smaller time steps increase accuracy but also computational time.  If simulations are unstable try reducing dt.
    * **Convergence criteria:**  Threshold for stopping the simulation based on changes in maximum velocity. Smaller values improve accuracy but prolong simulation time.
    * **End Time:** Instead of a convergence criteria, you can specify how long the simulation runs for.
    * **Override:** Set to 'y' to overwrite existing results for a given parameter set.  'n' will skip simulations if the folder already exists. Useful for adding new parameter sets to an existing batch of runs.
    * **Animation loops:** Number of frames to generate for the animation.  The total animation time is time step * animation loops.
    * **Verbose:** Prints output more frequently for easier tracking during runtime.

2. **Running Simulations (run_viper_simulations.py):** Execute `run_viper_simulations.py` to run the simulations defined in `parameters.csv`.  This script:
    * Creates individual directories for each simulation run, named according to the simulation parameters.
    * Modifies `viper.cfg` and `macro.txt` based on the parameters for each run.
    * Copies the appropriate mesh file to the simulation directory.
    * Runs `viper.exe` using the generated macro file.  Runs both the main macro for output data, and the animation macro for animation plt files.
    * Implements a mechanism to automatically reduce the time step if the simulation crashes due to instability, up to a maximum number of attempts.
    * Includes improved error handling and reporting, summarizing any error messages from Viper in a crash_summary.txt file.

3. **Tecplot Export (tecplot_export.py):** Run `tecplot_export.py` after the simulations are complete.  This script:
    * Loads the `tec_out.plt` file generated by Viper.
    * Creates various contour plots for different variables (U, V, P, vort_z, vel, psi) with and without mesh lines and vectors, saving them as JPEG images.  
    * Creates MP4 animations for each variable from the output `tec_animation_frame_*.plt` files.
    * Saves the outputs in a 'Simulation_[index]_Results' directory, where index refers to the 'Index' column in your parameter sheet, thus organizing output by simulation number.  This also makes it easy to rerun tecplot_export.py if something goes wrong.
    * This requires Tecplot with PyTecplot Connections to be turned ON.
    * Move this file to one of the local folders of a simulated run and run it to produce the results.

4. **Data Analysis (analyse_static_data.py):** Execute `analyse_static_data.py` within each simulation directory to perform data analysis. This script:
    * Reads output data files (`int_KE.dat`, `pressure_outlet_upper.dat`, etc.).
    * Calculates system gain.
    * Generates plots of key variables (internal kinetic energy, system gain, pressure outlets, flow rates).
    * Calculates and saves statistics (average, median, min, max, standard deviation, percentiles) for each dataset, based on the last 25% of data, representing when the simulation is closest to steady state.  These are appended to the result.txt file created during execution.
    * Saves processed data into a `.npz` file for further analysis.

5. **Batch Processing (batch_tecplot_export.py, batch_data_analyse.py):** You can automate post-processing for multiple simulation folders using the provided batch scripts:
    * `batch_tecplot_export.py`: Iterates through all subdirectories and runs `tecplot_export.py` within each.
    * `batch_data_analyse.py`: Iterates through all subdirectories and runs `analyse_static_data.py` within each.


## Files

* **`viper.exe`:**  The Viper solver executable.
* **`libiomp5md.dll`:**  A required DLL file for Viper.
* **`run_viper_simulations.py`:**  The main script for running simulations.
* **`tecplot_export.py`:**  The script for exporting Tecplot visualizations.
* **`batch_tecplot_export.py`:** The batch script for running tecplot_export.py.
* **`batch_data_analyse.py`:** The batch script for running analyse_static_data.py.
* **`analyse_static_data.py`:** The script for analysing post-processed data.
* **`parameters.csv`:** The CSV file for defining simulation parameters.
* **`viper.cfg`:** The Viper configuration file (modified by the scripts).
* **`macro.txt`:** The macro file for Viper (modified by the scripts).
* **`macro_animation.txt`:** The macro file for generating animation frames.
* **`fluidic_amplifier_res_*.msh`:** Mesh files for the geometry.
* **`README.txt`:** This documentation file.

## Getting Started

1. Ensure you have Python 3 installed. You can install the required libraries with `pip install -r requirements.txt`.

2. Place all the files from the repository into a new directory.
3. Edit the `parameters.csv` file to configure your desired simulations.
4. Run the `run_viper_simulations.py` script to execute the simulations.
5. Open Tecplot, and on the top menu go Scripting->PyTecplot Connections-> and tick "Accept Connections".
6. Run the `batch_tecplot_export.py` script to generate Tecplot visualizations.
7. Run the `batch_data_analyse.py` script to perform data analysis and produce plots and statistics.